<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CostCraft AI - Báo giá Nội thất Thông minh</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="style.css">
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.8.0"
  }
}
</script>
</head>
<body>

    <!-- Initial Loading Overlay -->
    <div id="initial-loader" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="container header-content">
            <h1 class="logo">
                <i class="fas fa-drafting-compass logo-icon"></i>
                <span>CostCraft AI</span>
            </h1>
            <div id="auth-container">
                <div id="logged-in-view" class="hidden">
                    <span id="user-email-display" class="user-email"></span>
                    <button id="logout-btn" class="btn btn-danger btn-sm">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Đăng xuất</span>
                    </button>
                </div>
                <div id="logged-out-view">
                    <button id="open-login-modal-btn" class="btn btn-primary btn-sm">Đăng nhập / Đăng ký</button>
                </div>
            </div>
        </div>
    </header>

    <div class="container main-container">
        <!-- Intro Section -->
        <div class="intro-section">
            <h2>Báo giá Nội thất Thông minh</h2>
            <p>Sử dụng trí tuệ nhân tạo để phân tích chi phí, tối ưu hóa vật liệu và tạo báo giá chuyên nghiệp chỉ trong vài giây.</p>
        </div>

        <!-- Tab Navigation -->
        <div class="tabs-container">
            <nav id="tabs" class="tabs-nav">
                <button data-tab="calculator" class="tab-btn active"><i class="fas fa-magic"></i>Trình Báo Giá</button>
                <button data-tab="quick-calc" class="tab-btn"><i class="fas fa-calculator"></i>Tính Nhanh</button>
                <button data-tab="materials" class="tab-btn"><i class="fas fa-boxes"></i>Kho Vật Tư</button>
                <button data-tab="config" class="tab-btn"><i class="fas fa-cogs"></i>Cấu hình</button>
                <button data-tab="saved" class="tab-btn"><i class="fas fa-folder-open"></i>Dự Án</button>
            </nav>
        </div>

        <!-- Tab Content -->
        <main id="tab-content">
            <!-- Tab 1: Trình Báo Giá -->
            <div id="calculator-tab" class="tab-pane active">
                <div class="grid-layout">
                    <div class="card main-card">
                        <h2 class="card-header">Tạo Báo giá Mới</h2>
                        <div class="content-wrapper calculator-form-content">
                            <!-- Step 1: Product Info -->
                            <div class="form-section" style="border-top: none; padding-top: 0; margin-top: 0;">
                                <h3 class="form-section-header"><span class="step-circle">1</span>Thông tin & Kích thước Sản phẩm</h3>
                                <div class="grid-2-col">
                                    <div class="form-group" style="margin-top:0;">
                                        <label for="item-name" class="form-label">Tên sản phẩm / dự án</label>
                                        <input type="text" id="item-name" class="input-style" placeholder="Vd: Tủ bếp dưới chân sắt">
                                    </div>
                                    <div class="form-group" style="margin-top:0;">
                                         <label for="item-type-input" class="form-label">Loại sản phẩm</label>
                                         <div id="item-type-combobox" class="combobox-container">
                                             <input type="text" id="item-type-input" class="input-style combobox-input" placeholder="Tìm hoặc chọn loại sản phẩm...">
                                             <input type="hidden" id="item-type" class="combobox-value">
                                             <div class="combobox-options-wrapper">
                                                 <ul class="combobox-options"></ul>
                                             </div>
                                         </div>
                                    </div>
                                </div>
                                <div class="grid-3-col" style="margin-top: 1.25rem;">
                                    <div><label for="item-length" class="form-label">Dài (mm)</label><input type="text" inputmode="decimal" id="item-length" class="input-style" placeholder="Vd: 2000"></div>
                                    <div><label for="item-width" class="form-label">Rộng (mm)</label><input type="text" inputmode="decimal" id="item-width" class="input-style" placeholder="Vd: 600"></div>
                                    <div><label for="item-height" class="form-label">Cao (mm)</label><input type="text" inputmode="decimal" id="item-height" class="input-style" placeholder="Vd: 850"></div>
                                </div>
                            </div>

                            <!-- Step 2: Components & Materials -->
                            <div class="form-section">
                                <h3 class="form-section-header"><span class="step-circle">2</span>Cấu thành & Vật liệu Ván</h3>
                                <div class="form-group">
                                    <label class="form-label">Vật liệu ván</label>
                                    <div class="grid-2-col">
                                        <div>
                                            <label for="main-material-wood-input" class="sub-label">Ván chính (Thùng, cánh)</label>
                                            <div id="main-material-wood-combobox" class="combobox-container">
                                                <input type="text" id="main-material-wood-input" class="input-style combobox-input" placeholder="Tìm hoặc chọn loại ván...">
                                                <input type="hidden" class="combobox-value">
                                                <div class="combobox-options-wrapper">
                                                    <ul class="combobox-options"></ul>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="main-material-back-panel-input" class="sub-label">Ván hậu tủ (nếu khác ván chính)</label>
                                            <div id="main-material-back-panel-combobox" class="combobox-container">
                                                <input type="text" id="main-material-back-panel-input" class="input-style combobox-input" placeholder="Tìm hoặc chọn loại ván...">
                                                <input type="hidden" class="combobox-value">
                                                <div class="combobox-options-wrapper">
                                                    <ul class="combobox-options"></ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="component-header">
                                        <div>
                                            <label class="form-label">Danh sách Chi tiết Cấu thành</label>
                                            <p class="form-text" style="margin-top: -0.25rem; margin-bottom: 0.75rem;">Kích thước được tính tự động từ công thức. Bạn có thể chọn vật liệu riêng cho từng chi tiết.</p>
                                        </div>
                                    </div>
                                    <div class="component-group-adder">
                                        <label class="form-label">Thêm Nhanh Cụm Chi tiết</label>
                                        <div class="accessory-adder">
                                            <div id="add-group-combobox" class="combobox-container">
                                                <input type="text" class="input-style combobox-input" placeholder="Tìm một cụm chi tiết...">
                                                <input type="hidden" class="combobox-value">
                                                <div class="combobox-options-wrapper"><ul class="combobox-options"></ul></div>
                                            </div>
                                            <input type="text" inputmode="decimal" id="add-group-quantity" class="input-style accessory-qty" placeholder="SL Cụm" value="1" min="1">
                                            <button id="add-group-btn" class="btn btn-secondary accessory-add-btn"><i class="fas fa-plus-circle"></i> Thêm Cụm</button>
                                        </div>
                                    </div>
                                    <div class="table-wrapper">
                                        <table id="component-table" class="data-table component-table">
                                            <thead>
                                                <tr>
                                                    <th class="th-style th-name">Tên Chi tiết</th>
                                                    <th class="th-style" style="width: 25%;">Vật liệu</th>
                                                    <th class="th-style">Dài</th>
                                                    <th class="th-style">Rộng</th>
                                                    <th class="th-style">SL</th>
                                                    <th class="th-style text-center th-delete">Xóa</th>
                                                </tr>
                                            </thead>
                                            <tbody id="components-table-body">
                                                <!-- JS will render component rows here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <button id="add-custom-component-btn" class="btn btn-secondary btn-sm" style="margin-top: 1rem;"><i class="fas fa-plus"></i> Thêm Chi tiết</button>
                                </div>
                            </div>
                            
                            <!-- Step 3: Accessories & Costs -->
                             <div class="form-section">
                                <h3 class="form-section-header"><span class="step-circle">3</span>Phụ kiện & Chi phí Hoàn thiện</h3>
                                <div class="form-group">
                                    <label for="edge-material-input" class="form-label">Vật liệu nẹp cạnh</label>
                                    <p class="form-text" style="margin-top: -0.25rem; margin-bottom: 0.75rem;">Chọn loại nẹp để tính chi phí dán cạnh tự động. Quy tắc dán cạnh được thiết lập trong tab Cấu hình.</p>
                                    <div id="edge-material-combobox" class="combobox-container">
                                        <input type="text" id="edge-material-input" class="input-style combobox-input" placeholder="Tìm hoặc chọn loại nẹp...">
                                        <input type="hidden" class="combobox-value">
                                        <div class="combobox-options-wrapper">
                                            <ul class="combobox-options"></ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="material-accessories" class="form-label">Vật tư phụ & Phụ kiện khác</label>
                                    <p class="form-text" style="margin-top: -0.25rem; margin-bottom: 0.75rem;">Thêm các phụ kiện khác như bản lề, ray trượt tại đây.</p>
                                    <div class="accessory-adder">
                                        <div id="main-material-accessories-combobox" class="combobox-container">
                                            <input type="text" class="input-style combobox-input" placeholder="Tìm phụ kiện, gia công, nẹp...">
                                            <input type="hidden" class="combobox-value">
                                            <div class="combobox-options-wrapper">
                                                <ul class="combobox-options"></ul>
                                            </div>
                                        </div>
                                        <input type="text" inputmode="decimal" id="accessory-quantity" class="input-style accessory-qty" placeholder="SL / mét" value="1" min="1">
                                        <button id="add-accessory-btn" class="btn btn-secondary accessory-add-btn"><i class="fas fa-plus"></i> Thêm</button>
                                    </div>
                                    <ul id="accessories-list" class="accessory-list"></ul>
                                </div>
                                <div class="grid-2-col" style="margin-top: 1.25rem;">
                                    <div class="form-group" style="margin-top: 0;">
                                        <label for="labor-cost" class="form-label">Chi phí nhân công (VND)</label>
                                        <input type="text" inputmode="decimal" id="labor-cost" class="input-style" value="0" placeholder="Vd: 500000">
                                    </div>
                                    <div class="form-group" style="margin-top: 0;">
                                        <label for="profit-margin" class="form-label">Lợi nhuận mong muốn (%)</label>
                                        <input type="text" inputmode="decimal" id="profit-margin" class="input-style" value="50">
                                    </div>
                                </div>
                            </div>
                           
                            <div class="main-actions-group">
                                <button id="save-item-btn" class="btn btn-secondary full-width" disabled>
                                    <i class="fas fa-save"></i> Lưu Dự án
                                </button>
                                <button id="analyze-btn" class="btn btn-primary full-width">
                                    <i class="fas fa-th-large"></i> Tối ưu Cắt ván với AI
                                </button>
                            </div>

                            <!-- Results Section -->
                            <div id="results-section" class="hidden">
                                <div id="results-content">
                                    <div id="price-summary-container" class="result-box">
                                        <div class="grid-3-col">
                                            <div class="price-card bg-indigo">
                                                <div class="price-label">Tổng Chi Phí</div>
                                                <div id="total-cost-value" class="price-value">0đ</div>
                                                <div class="price-sublabel">Gồm vật tư và nhân công</div>
                                            </div>
                                            <div class="price-card bg-yellow">
                                                <div class="price-label">Giá Bán Đề Xuất</div>
                                                <div id="suggested-price-value" class="price-value">0đ</div>
                                                <div class="price-sublabel">Đã gồm lợi nhuận mong muốn</div>
                                            </div>
                                            <div class="price-card bg-green">
                                                <div class="price-label">Lợi Nhuận Ước Tính</div>
                                                <div id="estimated-profit-value" class="price-value">0đ</div>
                                                <div class="price-sublabel">Sau khi trừ mọi chi phí</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="cost-breakdown-container" class="result-box"></div>
                                    
                                    <div id="cutting-layout-section" class="result-box hidden">
                                        <h3 class="result-box-header"><i class="fas fa-th-large"></i> Sơ đồ Cắt ván Gợi ý từ AI</h3>
                                        <div id="cutting-layout-loader" class="hidden">
                                            <div class="spinner"></div>
                                            <p>AI đang tối ưu sơ đồ cắt, vui lòng đợi...</p>
                                        </div>
                                        <div id="cutting-layout-summary"></div>
                                        <div id="cutting-layout-container" class="cutting-layout-container">
                                            <!-- AI-generated layouts will be rendered here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="login-prompt-view">
                            <div class="icon-prompt"><i class="fas fa-lock"></i></div>
                            <h3>Tính năng dành cho thành viên</h3>
                            <p>Vui lòng đăng nhập để bắt đầu báo giá và lưu dự án của bạn.</p>
                        </div>
                    </div>
                    <div class="sidebar-card card">
                        <h2 class="card-header">Công cụ & Hướng dẫn</h2>
                        <div class="content-wrapper calculator-form-content">
                            <!-- Product Preview -->
                             <div id="product-preview-section">
                                <h4><i class="fas fa-image"></i> Hình ảnh Sản phẩm</h4>
                                <input type="file" id="sidebar-image-input" class="hidden" accept="image/*">
                                <div id="sidebar-image-preview-wrapper" class="preview-canvas">
                                    <img id="sidebar-image-preview" src="" alt="Xem trước hình ảnh" class="hidden">
                                    <div id="sidebar-image-placeholder">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <p>Nhấp hoặc kéo thả ảnh vào đây</p>
                                    </div>
                                    <button id="sidebar-remove-image-btn" class="remove-image-btn hidden">&times;</button>
                                </div>
                            </div>
                            
                            <!-- Guide -->
                            <details class="guide-details" open>
                                <summary>
                                    <h4><i class="fas fa-question-circle"></i> Hướng dẫn sử dụng</h4>
                                </summary>
                                <ul>
                                    <li><strong>Chọn Loại Sản phẩm:</strong> Chọn một loại sản phẩm từ danh sách để tải cấu trúc chi tiết mặc định. Bạn có thể tùy chỉnh các loại sản phẩm này trong tab 'Cấu hình'.</li>
                                    <li><strong>Điền thông tin:</strong> Hoàn thiện các thông tin chi tiết về kích thước, vật liệu, và phụ kiện. Kết quả báo giá sẽ tự động cập nhật.</li>
                                    <li><strong>Tối ưu AI:</strong> Nhấn nút "Tối ưu Cắt ván với AI" để nhận sơ đồ cắt ván hiệu quả, giúp giảm thiểu vật tư thừa.</li>
                                    <li><strong>Lưu & Tải lại:</strong> Đăng nhập và lưu các dự án quan trọng để xem lại hoặc chỉnh sửa sau này.</li>
                                </ul>
                           </details>
                        </div>
                         <div class="login-prompt-view">
                            <div class="icon-prompt"><i class="fas fa-info-circle"></i></div>
                            <h3>Chào mừng bạn!</h3>
                            <p>Đăng nhập để mở khóa tất cả tính năng.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Quick Calculator -->
            <div id="quick-calc-tab" class="tab-pane hidden">
                <div class="card">
                    <h2 class="card-header"><i class="fas fa-calculator" style="margin-right: 0.75rem;"></i>Tính Giá Nhanh</h2>
                    <div class="content-wrapper quick-calc-form-content">
                        <p class="settings-intro">Công cụ này giúp bạn ước tính nhanh chi phí dựa trên tổng số vật tư. Mọi thay đổi sẽ được tự động cập nhật vào kết quả bên dưới.</p>
                        
                        <!-- Section 1: Board Materials -->
                        <div class="form-group" style="margin-top: 0;">
                            <h3 class="result-box-header" style="margin-bottom: 1.5rem; font-size: 1.1rem;"><span class="step-circle">1</span>Vật liệu ván</h3>
                            <div class="grid-2-col" style="gap: 0.5rem 1.25rem;">
                                <div>
                                    <label for="qc-area" class="form-label">Diện tích ván loại 1 (m²)</label>
                                    <input type="text" inputmode="decimal" id="qc-area" class="input-style" placeholder="Vd: 4.5">
                                </div>
                                <div>
                                    <label for="qc-material-wood-input" class="form-label">Loại ván 1 (Chính)</label>
                                    <div id="qc-material-wood-combobox" class="combobox-container">
                                        <input type="text" id="qc-material-wood-input" class="input-style combobox-input" placeholder="Tìm hoặc chọn loại ván...">
                                        <input type="hidden" class="combobox-value">
                                        <div class="combobox-options-wrapper">
                                            <ul class="combobox-options"></ul>
                                        </div>
                                    </div>
                                    <small id="qc-sheet-count-display" class="form-text" style="margin-top: 0.5rem; text-align: right; color: var(--primary-color); font-weight: 500;"></small>
                                </div>
                            </div>
                            <div class="grid-2-col" style="gap: 0.5rem 1.25rem; margin-top: 1.25rem;">
                                <div>
                                    <label for="qc-area-2" class="form-label">Diện tích ván loại 2 (m²)</label>
                                    <input type="text" inputmode="decimal" id="qc-area-2" class="input-style" placeholder="Vd: 1.2">
                                </div>
                                <div>
                                    <label for="qc-material-wood-2-input" class="form-label">Loại ván 2 (Phụ)</label>
                                    <div id="qc-material-wood-2-combobox" class="combobox-container">
                                        <input type="text" id="qc-material-wood-2-input" class="input-style combobox-input" placeholder="Tìm hoặc chọn loại ván...">
                                        <input type="hidden" class="combobox-value">
                                        <div class="combobox-options-wrapper">
                                            <ul class="combobox-options"></ul>
                                        </div>
                                    </div>
                                    <small id="qc-sheet-count-display-2" class="form-text" style="margin-top: 0.5rem; text-align: right; color: var(--primary-color); font-weight: 500;"></small>
                                </div>
                            </div>
                        </div>

                        <!-- Section 2: Accessories, Edge, and Other Costs -->
                        <div class="form-group">
                             <h3 class="result-box-header" style="margin-bottom: 1.5rem; font-size: 1.1rem;"><span class="step-circle">2</span>Phụ kiện, Nẹp & Chi phí Phát sinh</h3>
                            <div class="accessory-adder qc-accessory-adder">
                                <div id="qc-material-accessories-combobox" class="combobox-container">
                                    <input type="text" class="input-style combobox-input" placeholder="Tìm phụ kiện hoặc nẹp...">
                                    <input type="hidden" class="combobox-value">
                                    <div class="combobox-options-wrapper">
                                        <ul class="combobox-options"></ul>
                                    </div>
                                </div>
                                <input type="text" inputmode="decimal" id="qc-accessory-quantity" class="input-style accessory-qty" placeholder="SL / mét" value="1" min="0">
                                <button id="qc-add-accessory-btn" class="btn btn-secondary accessory-add-btn"><i class="fas fa-plus"></i> Thêm</button>
                            </div>
                            <ul id="qc-accessories-list" class="accessory-list" style="margin-top: 1rem; margin-bottom: 1.25rem;"></ul>
                        </div>

                        <!-- Section 3: Pricing Setup -->
                        <div class="form-group">
                            <h3 class="result-box-header" style="margin-bottom: 1.5rem; font-size: 1.1rem;"><span class="step-circle">3</span>Thiết lập Giá bán</h3>
                            <div class="grid-2-col" style="gap: 0.5rem 1.25rem;">
                                 <div>
                                    <label for="qc-install-cost" class="form-label">Chi phí lắp đặt & phát sinh (VND)</label>
                                    <input type="text" inputmode="decimal" id="qc-install-cost" class="input-style" placeholder="Vd: 500000" value="0" min="0">
                                </div>
                                <div>
                                    <label for="qc-profit-margin" class="form-label">Lợi nhuận mong muốn (%)</label>
                                    <input type="text" inputmode="decimal" id="qc-profit-margin" class="input-style" value="50" min="0">
                                </div>
                            </div>
                        </div>

                        <!-- Section 4: Results -->
                        <div id="qc-results-container" style="margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 2rem;">
                             <div class="grid-3-col">
                                <div class="price-card bg-indigo">
                                    <div class="price-label">Tổng Chi Phí</div>
                                    <div id="qc-total-cost-value" class="price-value">0đ</div>
                                    <div class="price-sublabel">Gồm tất cả vật tư và chi phí</div>
                                </div>
                                <div class="price-card bg-yellow">
                                    <div class="price-label">Giá Bán Đề Xuất</div>
                                    <div id="qc-suggested-price-value" class="price-value">0đ</div>
                                    <div class="price-sublabel">Đã gồm lợi nhuận mong muốn</div>
                                </div>
                                <div class="price-card bg-green">
                                    <div class="price-label">Lợi Nhuận Ước Tính</div>
                                    <div id="qc-estimated-profit-value" class="price-value">0đ</div>
                                    <div class="price-sublabel">Sau khi trừ mọi chi phí</div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="login-prompt-view">
                        <div class="icon-prompt"><i class="fas fa-calculator"></i></div>
                        <h3>Tính toán nhanh chóng</h3>
                        <p>Vui lòng đăng nhập để sử dụng công cụ tính giá nhanh dựa trên kho vật tư của bạn.</p>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Quản lý Vật tư -->
            <div id="materials-tab" class="tab-pane hidden">
                <div class="card">
                    <h2 class="card-header">Quản lý Kho Vật tư</h2>
                    <div class="content-wrapper materials-form-content">
                        <form id="material-form" class="material-form">
                            <input type="hidden" id="material-id">
                            <div class="grid-2-col">
                                <div>
                                    <label for="material-name" class="form-label">Tên vật tư</label>
                                    <input type="text" id="material-name" class="input-style" placeholder="Vd: Ván MDF An Cường 17mm" required>
                                </div>
                                <div>
                                    <label for="material-type" class="form-label">Loại vật tư</label>
                                    <select id="material-type" class="input-style" required>
                                        <option value="Ván">Ván</option>
                                        <option value="Cạnh">Cạnh</option>
                                        <option value="Phụ kiện">Phụ kiện</option>
                                        <option value="Gia Công">Gia Công</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid-2-col">
                                <div>
                                    <label for="material-price" class="form-label">Đơn giá</label>
                                    <input type="text" inputmode="decimal" id="material-price" class="input-style" placeholder="Vd: 550000" required>
                                </div>
                                <div>
                                    <label for="material-unit" class="form-label">Đơn vị tính</label>
                                    <input type="text" id="material-unit" class="input-style" placeholder="Vd: tấm, mét, cái" required>
                                </div>
                            </div>
                            <div>
                                <label for="material-notes" class="form-label">Ghi chú</label>
                                <input type="text" id="material-notes" class="input-style" placeholder="Vd: Khổ 1220x2440, chống ẩm">
                            </div>
                            <div class="button-group" style="justify-content: flex-end;">
                                <button type="button" id="cancel-edit-button" class="btn btn-secondary hidden">Hủy</button>
                                <button type="submit" class="btn btn-primary"><i class="fas fa-plus mr-2"></i> Thêm Vật tư</button>
                            </div>
                        </form>
                        <div class="table-container">
                             <h3 class="table-header">Danh sách Vật tư</h3>
                             <div class="material-controls">
                                <div class="filter-wrapper">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="material-filter-input" class="input-style" placeholder="Lọc theo tên hoặc ghi chú...">
                                </div>
                                <select id="material-sort-select" class="input-style">
                                    <option value="name-asc">Sắp xếp: Tên A-Z</option>
                                    <option value="name-desc">Sắp xếp: Tên Z-A</option>
                                    <option value="price-asc">Sắp xếp: Giá thấp nhất</option>
                                    <option value="price-desc">Sắp xếp: Giá cao nhất</option>
                                    <option value="type">Sắp xếp: Loại vật tư</option>
                                </select>
                             </div>
                            <div class="table-wrapper">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th class="th-style">Tên</th>
                                            <th class="th-style">Loại</th>
                                            <th class="th-style">Đơn giá</th>
                                            <th class="th-style">Ghi chú</th>
                                            <th class="th-style text-center">Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody id="materials-table-body">
                                        <!-- JS will render here -->
                                    </tbody>
                                </table>
                            </div>
                             <div id="pagination-controls" class="pagination-controls hidden">
                                <span id="page-info"></span>
                                <div class="button-group" style="margin: 0; justify-content: flex-end;">
                                    <button id="prev-page-btn" data-direction="prev" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Trước</button>
                                    <button id="next-page-btn" data-direction="next" class="btn btn-secondary">Sau <i class="fas fa-arrow-right"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="login-prompt-view">
                        <div class="icon-prompt"><i class="fas fa-boxes"></i></div>
                        <h3>Quản lý vật tư của bạn</h3>
                        <p>Vui lòng đăng nhập để thêm, sửa, xóa các loại vật tư cho xưởng của mình.</p>
                    </div>
                </div>
            </div>

            <!-- Tab: Configuration -->
            <div id="config-tab" class="tab-pane hidden">
                <div class="card">
                    <h2 class="card-header">Quản lý Loại Sản Phẩm</h2>
                    <div class="content-wrapper config-form-content">
                        <div class="config-layout">
                            <!-- Left: List of Product Types -->
                            <div class="config-list-panel">
                                 <form id="product-type-form">
                                    <input type="hidden" id="product-type-id">
                                    <div class="form-group" style="margin-top: 0;">
                                        <label for="product-type-name" class="form-label">Tên Loại Sản Phẩm</label>
                                        <input type="text" id="product-type-name" class="input-style" placeholder="Vd: Tủ Bếp Dưới" required>
                                    </div>
                                    <div class="button-group" style="justify-content: flex-start; margin-top: 0.75rem;">
                                        <button type="submit" class="btn btn-primary"><i class="fas fa-plus mr-2"></i> Thêm Mới</button>
                                        <button type="button" id="cancel-product-type-edit-btn" class="btn btn-secondary hidden">Hủy</button>
                                    </div>
                                </form>
                                <hr class="form-divider">
                                <div id="product-types-list" class="config-list">
                                    <!-- JS renders list here -->
                                </div>
                            </div>

                            <!-- Right: Editor for the selected Product Type -->
                            <div id="product-type-editor" class="config-editor-panel hidden">
                                <h3 id="product-type-editor-title" class="table-header">Chỉnh sửa: Tủ Bếp Dưới</h3>
                                <div class="form-group" style="margin-top: 0;">
                                    <label class="form-label">Thêm chi tiết vào loại sản phẩm</label>
                                    <div class="accessory-adder">
                                        <div id="pt-component-add-combobox" class="combobox-container">
                                            <input type="text" class="input-style combobox-input" placeholder="Tìm tên chi tiết...">
                                            <input type="hidden" class="combobox-value">
                                            <div class="combobox-options-wrapper"><ul class="combobox-options"></ul></div>
                                        </div>
                                        <input type="text" inputmode="decimal" id="pt-component-add-qty" class="input-style accessory-qty" placeholder="SL" value="1" min="1">
                                        <button id="pt-component-add-btn" class="btn btn-secondary accessory-add-btn"><i class="fas fa-plus"></i> Thêm</button>
                                    </div>
                                </div>
                                <div class="table-container">
                                    <h4 class="config-sub-header">Danh sách chi tiết hiện tại</h4>
                                     <div class="table-wrapper">
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th class="th-style">Tên Chi tiết</th>
                                                    <th class="th-style text-center">Số lượng</th>
                                                    <th class="th-style text-center">Xóa</th>
                                                </tr>
                                            </thead>
                                            <tbody id="pt-components-list">
                                                <!-- JS renders components for selected type here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div class="login-prompt-view">
                        <div class="icon-prompt"><i class="fas fa-cogs"></i></div>
                        <h3>Cấu hình sản phẩm</h3>
                        <p>Vui lòng đăng nhập để tạo và quản lý các mẫu sản phẩm của bạn.</p>
                    </div>
                </div>

                <div class="card" style="margin-top: 2rem;">
                    <h2 class="card-header">Quản lý Nhóm Chi tiết (Cụm)</h2>
                    <div class="content-wrapper config-form-content">
                        <p class="settings-intro">Tạo các cụm chi tiết có thể tái sử dụng, ví dụ như "Cụm hộc kéo" hoặc "Bộ cánh cửa", để thêm nhanh vào các dự án trong Trình Báo Giá.</p>
                        <div class="config-layout">
                            <!-- Left: List of Component Groups -->
                            <div class="config-list-panel">
                                <form id="component-group-form">
                                    <input type="hidden" id="component-group-id">
                                    <div class="form-group" style="margin-top: 0;">
                                        <label for="component-group-name" class="form-label">Tên Nhóm / Cụm</label>
                                        <input type="text" id="component-group-name" class="input-style" placeholder="Vd: Cụm Hộc Kéo" required>
                                    </div>
                                    <div class="button-group" style="justify-content: flex-start; margin-top: 0.75rem;">
                                        <button type="submit" class="btn btn-primary"><i class="fas fa-plus mr-2"></i> Thêm Mới</button>
                                        <button type="button" id="cancel-component-group-edit-btn" class="btn btn-secondary hidden">Hủy</button>
                                    </div>
                                </form>
                                <hr class="form-divider">
                                <div id="component-groups-list" class="config-list">
                                    <!-- JS renders list here -->
                                </div>
                            </div>

                            <!-- Right: Editor for the selected Component Group -->
                            <div id="component-group-editor" class="config-editor-panel hidden">
                                <h3 id="component-group-editor-title" class="table-header">Chỉnh sửa: Cụm Hộc Kéo</h3>
                                <div class="form-group" style="margin-top: 0;">
                                    <label class="form-label">Thêm chi tiết vào nhóm</label>
                                    <div class="accessory-adder">
                                        <div id="cg-component-add-combobox" class="combobox-container">
                                            <input type="text" class="input-style combobox-input" placeholder="Tìm tên chi tiết...">
                                            <input type="hidden" class="combobox-value">
                                            <div class="combobox-options-wrapper"><ul class="combobox-options"></ul></div>
                                        </div>
                                        <input type="text" inputmode="decimal" id="cg-component-add-qty" class="input-style accessory-qty" placeholder="SL" value="1" min="1">
                                        <button id="cg-component-add-btn" class="btn btn-secondary accessory-add-btn"><i class="fas fa-plus"></i> Thêm</button>
                                    </div>
                                </div>
                                <div class="table-container">
                                    <h4 class="config-sub-header">Danh sách chi tiết hiện tại trong nhóm</h4>
                                    <div class="table-wrapper">
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th class="th-style">Tên Chi tiết</th>
                                                    <th class="th-style text-center">Số lượng</th>
                                                    <th class="th-style text-center">Xóa</th>
                                                </tr>
                                            </thead>
                                            <tbody id="cg-components-list">
                                                <!-- JS renders components for selected group here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div class="login-prompt-view">
                        <div class="icon-prompt"><i class="fas fa-cubes"></i></div>
                        <h3>Tạo cụm chi tiết</h3>
                        <p>Vui lòng đăng nhập để quản lý các nhóm chi tiết có thể tái sử dụng.</p>
                    </div>
                </div>

                <div class="card" style="margin-top: 2rem;">
                    <h2 class="card-header">Quản lý Tên Chi tiết & Công thức</h2>
                    <div class="content-wrapper component-names-content">
                        <form id="component-name-form" class="material-form">
                            <input type="hidden" id="component-name-id">
                            <div>
                                <label for="component-name-input" class="form-label">Tên chi tiết</label>
                                <input type="text" id="component-name-input" class="input-style" placeholder="Vd: Hông Trái, Đáy, Nóc..." required>
                            </div>
                             <div class="grid-2-col" style="margin-top: 1rem;">
                                <div>
                                    <label for="component-length-formula" class="form-label">Công thức tính Chiều Dài</label>
                                    <input type="text" id="component-length-formula" class="input-style" placeholder="Vd: L - 2*t">
                                    <p class="form-text">Biến: L, W, H, t (Dài, Rộng, Cao, Dày ván)</p>
                                </div>
                                <div>
                                    <label for="component-width-formula" class="form-label">Công thức tính Chiều Rộng</label>
                                    <input type="text" id="component-width-formula" class="input-style" placeholder="Vd: W">
                                </div>
                            </div>
                            <div class="form-group" style="margin-top: 1rem;">
                                <label class="form-label">Quy tắc dán cạnh mặc định</label>
                                <p class="form-text" style="margin-top:-0.25rem; margin-bottom: 0.75rem;">Xác định các cạnh sẽ được tính chi phí nẹp tự động. D1/D2 là 2 cạnh dài, R1/R2 là 2 cạnh rộng của chi tiết.</p>
                                <div class="edge-banding-rules">
                                    <label><input type="checkbox" id="component-edge-1"> Cạnh dài 1</label>
                                    <label><input type="checkbox" id="component-edge-2"> Cạnh dài 2</label>
                                    <label><input type="checkbox" id="component-edge-3"> Cạnh rộng 1</label>
                                    <label><input type="checkbox" id="component-edge-4"> Cạnh rộng 2</label>
                                </div>
                            </div>
                            <div class="button-group" style="justify-content: flex-end;">
                                <button type="button" id="cancel-component-name-edit-btn" class="btn btn-secondary hidden">Hủy</button>
                                <button type="submit" class="btn btn-primary"><i class="fas fa-plus mr-2"></i> Thêm Tên</button>
                            </div>
                        </form>
                        <div class="table-container">
                            <h3 class="table-header">Danh sách Tên Chi tiết</h3>
                            <div class="material-controls">
                               <div class="filter-wrapper">
                                   <i class="fas fa-search"></i>
                                   <input type="text" id="cn-filter-input" class="input-style" placeholder="Lọc theo tên...">
                               </div>
                            </div>
                            <div class="table-wrapper">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th class="th-style" style="width: 25%;">Tên</th>
                                            <th class="th-style">CT Dài</th>
                                            <th class="th-style">CT Rộng</th>
                                            <th class="th-style text-center" colspan="4">Dán cạnh (D1-D2-R1-R2)</th>
                                            <th class="th-style text-center" style="width: 15%;">Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody id="component-names-table-body">
                                        <!-- JS will render here -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="cn-pagination-controls" class="pagination-controls hidden">
                                <span id="cn-page-info"></span>
                                <div class="button-group" style="margin: 0; justify-content: flex-end;">
                                    <button id="cn-prev-page-btn" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Trước</button>
                                    <button id="cn-next-page-btn" class="btn btn-secondary">Sau <i class="fas fa-arrow-right"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="login-prompt-view">
                        <div class="icon-prompt"><i class="fas fa-list-alt"></i></div>
                        <h3>Tùy chỉnh danh sách chi tiết</h3>
                        <p>Vui lòng đăng nhập để quản lý danh sách tên chi tiết của bạn.</p>
                    </div>
                </div>
            </div>


            <!-- Tab 4: Dự án đã lưu -->
            <div id="saved-tab" class="tab-pane hidden">
                 <div class="card">
                    <h2 class="card-header">Các Dự án Đã Lưu</h2>
                    <div class="content-wrapper saved-items-content">
                        <div class="table-container">
                            <div class="table-wrapper">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th class="th-style" style="width: 30%;">Tên dự án</th>
                                            <th class="th-style">Giá Bán</th>
                                            <th class="th-style">Chi Phí</th>
                                            <th class="th-style">Lợi Nhuận</th>
                                            <th class="th-style">Ngày tạo</th>
                                            <th class="th-style text-center">Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody id="saved-items-table-body">
                                        <!-- JS will render here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="login-prompt-view">
                        <div class="icon-prompt"><i class="fas fa-folder-open"></i></div>
                        <h3>Xem lại dự án</h3>
                        <p>Vui lòng đăng nhập để xem các dự án đã lưu của bạn.</p>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Modals -->
    <div id="login-modal" class="modal-overlay hidden">
        <div class="modal-content login-modal-content">
            <button class="modal-close-btn">&times;</button>
            <div class="login-modal-header">
                <i class="fas fa-drafting-compass logo-icon"></i>
                <h3 class="modal-title">Chào mừng tới CostCraft AI</h3>
            </div>
            <p class="modal-subtitle">Đăng nhập để lưu trữ, quản lý và tối ưu hóa các dự án của bạn một cách chuyên nghiệp.</p>
            <div id="login-error" class="error-message"></div>
            <button id="google-login-btn" class="google-btn">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" width="18" height="18">
                <span>Đăng nhập với Google</span>
            </button>
            <div class="remember-me-container">
                <input type="checkbox" id="remember-me-checkbox" checked>
                <label for="remember-me-checkbox">Duy trì đăng nhập</label>
            </div>
        </div>
    </div>
    
    <div id="view-item-modal" class="modal-overlay hidden">
        <div class="modal-content modal-lg">
            <button class="modal-close-btn">&times;</button>
            <h3 id="view-item-title" class="modal-title" style="text-align: left;"></h3>
            <div id="view-item-content" class="modal-body"></div>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="modal-title-sm">Xác nhận</h3>
            <p id="confirm-message" class="confirm-text"></p>
            <div class="confirm-actions">
                <button id="confirm-cancel-btn" class="btn btn-secondary">Hủy</button>
                <button id="confirm-ok-btn" class="btn btn-danger">Đồng ý</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>
    
    <!-- Footer -->
    <footer class="footer">
        <p>&copy; 2024 CostCraft AI. Hỗ trợ bởi Trí tuệ Nhân tạo.</p>
    </footer>

    <!-- Scripts -->
    <script type="module" src="script.js"></script>
    <script type="module" src="utils.js"></script>
    <script type="module" src="calculator.js"></script>

</body>
</html>